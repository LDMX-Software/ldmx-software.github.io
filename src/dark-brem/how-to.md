# How to Make Signal Samples

This page is focused on how to produce dark brem signal samples using
the G4DarkBreM package integrated into ldmx-sw. It is focused on having
the dark brem occur within the target although having it occur within
the ECal is also supported in ldmx-sw.

As mentioned in the prior page, the procedure for making signal samples
is two steps. First, a reference library is produced using MadGraph and
then the reference library is used by the Geant4 simulation to model
the dark brem interaction. The second stage is what happens within
ldmx-sw and its simulation framework while the first part is done outside
of ldmx-sw.

## Generating a Reference Library
The technical requirements upon the library making it usable by G4DarkBreM
are written [in its parseLibrary documentation](https://tomeichlersmith.github.io/G4DarkBreM/namespaceg4db.html#a5ce098d2be7196d71e64a5632591cdea)
Theoretically, any program could generate this reference library and have 
it usable by G4DarkBreM; however, it has only been tested and validated with
libraries generated by a specific configuration of MadGraph which just so happens
to be a configuration of MadGraph that is useful to LDMX and has been packaged
into a container similar to how ldmx-sw and its dependencies are.

For details on the MadGraph configuration and how to use it, visit the GitHub
project [tomeichlersmith/dark-brem-lib-gen](https://github.com/tomeichlersmith/dark-brem-lib-gen).
Unless you plan to add new features or fix some sort of issue, you _will not_
need this repository and instead only require a script wrapping the container
running process for you.

The script only needs to be downloaded once and it only needs to be `source`d
once inside each terminal you wish to run in.
```bash
# download the dark-brem-lib-gen environment script
wget https://raw.githubusercontent.com/tomeichlersmith/dark-brem-lib-gen/main/env.sh
# initialize the environment
source env.sh
```
Now a new bash function `dbgen` is defined which you can use (similar to `ldmx`) to
interact with the containerized MadGraph and generate dark brem events.
Further configuration of your local `dbgen` setup is possible now. Below, I've
written some dummy commands which are helpful for various reasons.
- `dbgen use v4.5` : it is helpful to pin the version you are using so that
  future analyzers of the data (including yourself) know exactly how it was generated
- `dbgen cache /big/cache/dir` : on clusters where you are using `singularity`,
  you will probably need to move the directory where `singularity` caches downloaded
  layers because, by default, it uses your home directory which probably doesn't have
  enough space. One option, if you are also using `ldmx` is to put the cache in the
  same place the `ldmx` cache is `dbgen cache ${LDMX_BASE}/.singularity`.
- `dbgen work /scratch/dir` : the working directory where intermediate files will
  be written. It needs to be large enough to hold a copy of MadGraph (>1GB). On laptops,
  the default `/tmp` directory is probably fine but this will probably need to be changed
  on clusters. For example, at SLAC you will want `dbgen work /scratch/$USER`.
- `dbgen dest /path/to/destination` : set where you would like the generate library to be put.
  By default, it is whereever you execute `dbgen run` but you may want the output directory
  to be somewhere else with more space.

You can view all of the runtime options (and test that the environment is setup reasonably)
by running the container and asking for the usage information.
```bash
dbgen run --help
```

The defaults for the runtime options align pretty well with the LDMX signal use case, so
lets just run it with defaults and obtain a library to use later. This usually takes a few minutes
but may be faster/slower depending on the computer you are using to run.
```bash
dbgen run
```

Now we have a new directory created in the current directory (or where-ever you set `dest` to be)
that has several LHE files within it. This directory of LHE files is the reference library we can
give to the Geant4 simulation.

## Simulating Dark Brem in ldmx-sw
We keep a few files within ldmx-sw/Biasing related to dark brem simulation which will be helpful places
to reference as examples.
- [ldmx-sw/Biasing/test/target_db.py](https://github.com/LDMX-Software/ldmx-sw/blob/trunk/Biasing/test/target_db.py)
  a config which runs dark brem simulation in the target using the example reference library shipped
  with G4DarkBreM.
- [ldmx-sw/Biasing/python/target.py](https://github.com/LDMX-Software/ldmx-sw/blob/trunk/Biasing/python/target.py#L180) is a configuration module with the `dark_brem` function which configures a simulation to do dark brem
  within the target. This function is what we will unpack below to explain the various pieces configuring
  the simulation.

